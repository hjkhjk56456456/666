<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube视频下载器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen font-inter">
    <div class="container mx-auto px-4 py-12 max-w-4xl">
        <!-- 页面标题区域 -->
        <div class="text-center mb-10">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-dark mb-3">
                <i class="fa fa-youtube-play text-red-500 mr-3"></i>YouTube视频下载器
            </h1>
            <p class="text-slate-600 text-lg max-w-2xl mx-auto">
                简单、快速地下载YouTube视频，支持多种分辨率选择，完全免费使用
            </p>
        </div>

        <!-- 主功能卡片 -->
        <div class="bg-white rounded-2xl p-6 md:p-8 card-shadow mb-8">
            <!-- URL输入区域 -->
            <div class="mb-8">
                <label for="videoUrl" class="block text-sm font-medium text-slate-700 mb-2">
                    YouTube视频链接
                </label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input 
                        type="url" 
                        id="videoUrl" 
                        placeholder="https://www.youtube.com/watch?v=..." 
                        class="flex-1 px-4 py-3 border border-slate-300 rounded-lg input-focus transition-all"
                        required
                    >
                    <button 
                        id="fetchBtn" 
                        class="px-6 py-3 bg-primary hover:bg-primary/90 text-white font-medium rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                        <i class="fa fa-search"></i>
                        <span>解析视频</span>
                    </button>
                </div>
                <p id="urlError" class="hidden mt-2 text-red-500 text-sm"></p>
            </div>

            <!-- 分辨率选择区域 (默认隐藏) -->
            <div id="resolutionSection" class="hidden mb-8">
                <label for="resolutionSelect" class="block text-sm font-medium text-slate-700 mb-2">
                    选择分辨率
                </label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <select 
                        id="resolutionSelect" 
                        class="flex-1 px-4 py-3 border border-slate-300 rounded-lg input-focus transition-all"
                    >
                        <option value="">-- 请选择分辨率 --</option>
                    </select>
                    <button 
                        id="downloadBtn" 
                        class="px-6 py-3 bg-secondary hover:bg-secondary/90 text-white font-medium rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                        <i class="fa fa-download"></i>
                        <span>下载视频</span>
                    </button>
                </div>
            </div>

            <!-- 视频信息区域 (默认隐藏) -->
            <div id="videoInfo" class="hidden mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <h3 id="videoTitle" class="font-medium text-slate-800 mb-2 truncate"></h3>
                <div class="flex items-center text-sm text-slate-600 gap-4">
                    <span id="videoAuthor"><i class="fa fa-user mr-1"></i></span>
                    <span id="videoDuration"><i class="fa fa-clock-o mr-1"></i></span>
                </div>
            </div>

            <!-- 进度显示区域 (默认隐藏) -->
            <div id="progressSection" class="hidden">
                <div class="mb-2 flex justify-between text-sm">
                    <span id="progressText" class="text-slate-600">准备下载...</span>
                    <span id="progressPercent" class="font-medium text-primary">0%</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2.5 mb-2">
                    <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p id="downloadStatus" class="text-sm text-slate-500 italic"></p>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="bg-slate-50 rounded-xl p-6">
            <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                <i class="fa fa-info-circle text-primary"></i>
                使用说明
            </h3>
            <ul class="space-y-2 text-slate-600 text-sm">
                <li class="flex items-start gap-2">
                    <i class="fa fa-check-circle text-secondary mt-1"></i>
                    <span>复制YouTube视频链接并粘贴到输入框中</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fa fa-check-circle text-secondary mt-1"></i>
                    <span>点击"解析视频"按钮获取可下载的分辨率列表</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fa fa-check-circle text-secondary mt-1"></i>
                    <span>选择所需分辨率，点击"下载视频"按钮开始下载</span>
                </li>
                <li class="flex items-start gap-2">
                    <i class="fa fa-exclamation-circle text-amber-500 mt-1"></i>
                    <span>本工具仅用于个人学习研究，请勿用于商业用途或侵犯版权</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="text-center text-slate-500 text-sm py-6">
        <p>© 2025 YouTube视频下载器 | 本工具不存储任何视频内容，所有下载均来自YouTube官方服务器</p>
    </footer>

    <script>
        // DOM元素引用
        const videoUrlInput = document.getElementById('videoUrl');
        const fetchBtn = document.getElementById('fetchBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const resolutionSection = document.getElementById('resolutionSection');
        const videoInfo = document.getElementById('videoInfo');
        const videoTitle = document.getElementById('videoTitle');
        const videoAuthor = document.getElementById('videoAuthor');
        const videoDuration = document.getElementById('videoDuration');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const downloadStatus = document.getElementById('downloadStatus');
        const urlError = document.getElementById('urlError');

        // 状态变量
        let currentVideoId = null;

        // 解析视频按钮点击事件
        fetchBtn.addEventListener('click', async () => {
            const url = videoUrlInput.value.trim();
            
            // 验证URL
            if (!isValidYouTubeUrl(url)) {
                showError(urlError, '请输入有效的YouTube视频链接');
                return;
            }
            
            // 隐藏错误信息
            hideError(urlError);
            
            // 显示加载状态
            setButtonLoading(fetchBtn, true);
            
            try {
                // 提取视频ID
                const videoId = extractVideoId(url);
                currentVideoId = videoId;
                
                // 调用后端API获取视频信息
                const response = await fetch(`/api/video-info?video_id=${videoId}`);
                
                if (!response.ok) {
                    throw new Error('无法获取视频信息，请检查链接是否有效');
                }
                
                const data = await response.json();
                
                // 更新UI显示视频信息
                updateVideoInfo(data);
                
                // 填充分辨率选项
                populateResolutions(data.streams);
                
                // 显示分辨率选择区域
                resolutionSection.classList.remove('hidden');
                
            } catch (error) {
                showError(urlError, error.message);
            } finally {
                // 恢复按钮状态
                setButtonLoading(fetchBtn, false);
            }
        });

        // 下载按钮点击事件
        downloadBtn.addEventListener('click', async () => {
            const resolution = resolutionSelect.value;
            
            if (!resolution) {
                alert('请选择视频分辨率');
                return;
            }
            
            // 显示进度区域
            progressSection.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = '准备下载...';
            downloadStatus.textContent = '';
            
            // 禁用下载按钮
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>下载中...</span>';
            
            try {
                // 创建下载链接
                const downloadUrl = `/api/download?video_id=${currentVideoId}&resolution=${resolution}`;
                
                // 使用fetch API下载视频，监控进度
                const response = await fetch(downloadUrl);
                
                if (!response.ok) {
                    throw new Error('下载失败，请重试');
                }
                
                // 获取文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                const fileName = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `video_${Date.now()}.mp4`;
                
                // 创建下载链接并触发下载
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // 更新状态
                progressText.textContent = '下载完成!';
                progressPercent.textContent = '100%';
                progressBar.style.width = '100%';
                downloadStatus.textContent = '视频已成功下载到您的设备';
                
            } catch (error) {
                progressText.textContent = '下载失败';
                downloadStatus.textContent = error.message;
                downloadStatus.classList.add('text-red-500');
            } finally {
                // 恢复按钮状态
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fa fa-download"></i><span>下载视频</span>';
            }
        });

        // 辅助函数：验证YouTube URL
        function isValidYouTubeUrl(url) {
            const regex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/watch\?v=[\w-]{11}/;
            return regex.test(url);
        }

        // 辅助函数：提取视频ID
        function extractVideoId(url) {
            const match = url.match(/v=([\w-]{11})/);
            return match ? match[1] : null;
        }

        // 辅助函数：显示错误信息
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // 辅助函数：隐藏错误信息
        function hideError(element) {
            element.classList.add('hidden');
        }

        // 辅助函数：设置按钮加载状态
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>解析中...</span>';
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="fa fa-search"></i><span>解析视频</span>';
            }
        }

        // 辅助函数：更新视频信息显示
        function updateVideoInfo(data) {
            videoTitle.textContent = data.title;
            videoAuthor.innerHTML = `<i class="fa fa-user mr-1"></i>${data.author}`;
            videoDuration.innerHTML = `<i class="fa fa-clock-o mr-1"></i>${formatDuration(data.duration)}`;
            videoInfo.classList.remove('hidden');
        }

        // 辅助函数：填充分辨率选项
        function populateResolutions(streams) {
            // 清空现有选项
            resolutionSelect.innerHTML = '<option value="">-- 请选择分辨率 --</option>';
            
            // 添加新选项
            streams.forEach(stream => {
                const option = document.createElement('option');
                option.value = stream.itag;
                option.textContent = `${stream.resolution} (${formatFileSize(stream.filesize)})`;
                resolutionSelect.appendChild(option);
            });
        }

        // 辅助函数：格式化时长
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // 辅助函数：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024 * 1024) {
                return `${(bytes / 1024).toFixed(1)} KB`;
            } else {
                return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            }
        }
    </script>
</body>
</html>